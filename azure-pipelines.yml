name: GrowingIO Design Preview

trigger: none

pr:
  autoCancel: true
  branches:
    exclude:
      - gh-pages

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: site
    jobs:
      - job: Build_Site
        steps:
          - checkout: self
            displayName: 'Checkout'
            clean: true
            fetchDepth: 1
          - task: NodeTool@0
            displayName: 'Install Node@12.x'
            inputs:
              versionSpec: '12.13.1'
          - script: yarn bootstrap
            displayName: 'Bootstrap all packages'
          - script: yarn build
            displayName: 'Build all packages'
          - script: yarn build:website
            displayName: 'Build website'
          - script: |
              export DEPLOY_DOMAIN=https://preview-$(System.PullRequest.PullRequestNumber)-gio-design.surge.sh
              echo "Deploy to $DEPLOY_DOMAIN"
              npx surge --project ./packages/website/dist --domain $DEPLOY_DOMAIN --token $(SURGE_TOKEN)
            displayName: 'Deploy website'
          - task: GitHubComment@0
            displayName: 'Comment on PR'
            inputs:
              gitHubConnection: 'growingio'
              repositoryName: '$(Build.Repository.Name)'
              id: '$(System.PullRequest.PullRequestNumber)'
              comment: 'Deploy preview for (gio-design)[https://preview-$(System.PullRequest.PullRequestNumber)-gio-design.surge.sh] ready!'

      - job: Build_Site_Failed
        dependsOn: Build_Site
        condition: failed()
        steps:
          - script: |
              echo "build site failed"
            displayName: 'Comment on github'